# Message Queue Chat

Мессенджер с накоплением сообщений и WebSocket уведомлениями в реальном времени.

## Описание

Приложение представляет собой чат с буферизацией сообщений в MongoDB. 
Основные особенности:

1. **Накопление сообщений**: Сервер накапливает сообщения пачками по 10 штук перед отправкой в MongoDB, либо отправляет их по таймауту в 1 секунду (что наступит раньше).
2. **Визуализация задержки**: Клиентская часть отображает таймер обратного отсчета, показывающий время до следующей отправки сообщений.
3. **WebSocket уведомления**: При добавлении новых сообщений в MongoDB, сервер отправляет уведомления всем подключенным клиентам через WebSocket.
4. **Отказоустойчивость**: При отключении сервера сообщения сохраняются и не теряются.
5. **Сохранение состояния**: При перезапуске сервер продолжает отслеживание изменений с того места, где остановился.

## Структура проекта

- `src/` - исходный код приложения
  - `server.ts` - основной файл сервера
  - `routes/` - обработчики HTTP запросов
  - `db/` - работа с базой данных
  - `utils/` - вспомогательные модули
  - `ws/` - WebSocket обработчики
  - `models/` - типы и интерфейсы
- `public/` - клиентская часть
  - `index.html` - интерфейс чата

## Технические особенности

### Серверная часть

- **Стек технологий**: Node.js с Express, TypeScript, MongoDB, WebSockets (ws)
- **Буферизация**: Накопление сообщений в памяти и отправка пачками в MongoDB
- **Отслеживание изменений**: Опрос MongoDB для получения новых сообщений
- **Восстановление**: Сохранение последнего ID обработанного сообщения для продолжения отслеживания после перезапуска

### Клиентская часть

- **Пользовательский интерфейс**: Чистый HTML/CSS/JavaScript без фреймворков
- **Авторизация**: Сохранение имени пользователя в localStorage
- **Реальное время**: WebSocket для мгновенного получения новых сообщений
- **Индикация обновлений**: Таймер обратного отсчета, показывающий время до следующего обновления (1 секунда)

## Особенности интерфейса

- **Экран входа**: Ввод имени пользователя для начала работы с чатом
- **Чат**: Отображение списка сообщений с разделением на "свои" и "чужие"
- **Индикаторы соединения**: Визуальное отображение статуса WebSocket соединения
- **Таймер обновлений**: Обратный отсчет времени до следующей отправки сообщений в MongoDB
- **Автоматическое переподключение**: Повторные попытки подключения при обрыве соединения

## API

### REST Endpoints

- `GET /messages` - получить все сообщения с пагинацией
- `POST /messages` - отправить новое сообщение

### WebSocket События

- `new_message` - новое сообщение добавлено в базу
- `info` - информационные сообщения от сервера

## Установка и запуск

### Предварительные требования

- Node.js 16+
- MongoDB 4+

### Установка

```bash
# Клонирование репозитория
git clone <url репозитория>
cd message-queue-chat

# Установка зависимостей
npm install
```

### Настройка

Создайте файл `.env` и укажите в нем необходимые переменные окружения:

```
PORT=3000
MONGO_URL=mongodb://localhost:27017
DB_NAME=chat
```

### Запуск

```bash
# Режим разработки
npm run dev

# Сборка и запуск в продакшен
npm run build
npm start
```

## Механизмы работы с данными

### Накопление сообщений

1. При получении сообщения от клиента оно добавляется в буфер
2. Если буфер достигает 10 сообщений, происходит немедленная отправка в MongoDB
3. Если буфер содержит менее 10 сообщений, устанавливается таймер на 1 секунду
4. По истечении таймера все сообщения из буфера отправляются в MongoDB

### Отслеживание изменений

1. При запуске сервер загружает ID последнего обработанного сообщения
2. Выполняется периодический опрос MongoDB для поиска новых сообщений (с _id > последнего ID)
3. При обнаружении новых сообщений они отправляются клиентам через WebSocket
4. ID последнего сообщения сохраняется для следующего запуска

## Лицензия

MIT 